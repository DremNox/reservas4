{% extends "dashboard/_layout.html" %}
{% set titulo = "Estado de puntos" %}
{% set subtitulo = "Actualiza ahora el estado de todos tus conectores activos" %}

{% block content %}
<div class="card card-soft">
  <div class="card-body d-flex align-items-center justify-content-between">
    <div>
      <div class="fw-semibold">Refrescar estados</div>
      <div class="text-secondary small">Lanza el scraping con tus cookies actuales.</div>
    </div>
    <button id="btn-refresh-estados" class="btn btn-primary">Refrescar ahora</button>
  </div>
</div>

<div id="refresh-result" class="mt-3"></div>

<script>
document.getElementById('btn-refresh-estados').addEventListener('click', async () => {
  const btn = event.currentTarget;
  btn.disabled = true; btn.textContent = 'Actualizando...';
  try {
    const res = await fetch('{{ url_for("dash.estado_refresh") }}', { method: 'POST' });
    const data = await res.json();
    const box = document.getElementById('refresh-result');
    if (!data.ok) {
      box.innerHTML = `<div class="alert alert-danger">⚠️ ${data.error || 'Error desconocido'}</div>`;
    } else {
      box.innerHTML = `<div class="alert alert-success">✅ Actualizados ${data.count} conectores.</div>`;
    }
  } catch (e) {
    document.getElementById('refresh-result').innerHTML =
      `<div class="alert alert-danger">⚠️ Fallo al refrescar: ${e}</div>`;
  } finally {
    btn.disabled = false; btn.textContent = 'Refrescar ahora';
  }
});
</script>
{% endblock %}
