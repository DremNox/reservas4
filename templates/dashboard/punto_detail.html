{% extends "dashboard/_layout.html" %}
{% set titulo = "Punto: " ~ p.Nombre %}
{% set subtitulo = "Conectores y estado actual" %}

{% block content %}
<div class="mb-3 d-flex justify-content-end">
  <button id="btn-refresh-punto" class="btn btn-outline-primary">Refrescar estados de este punto</button>
</div>
<div id="punto-refresh-result"></div>
<div class="card card-soft mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-semibold">{{ p.Nombre }}</div>
        {% if p.Notas %}<div class="text-secondary small">{{ p.Notas }}</div>{% endif %}
      </div>
      <div>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('puntos.puntos_list') }}">&larr; Volver</a>
      </div>
    </div>
  </div>
</div>

<div class="card card-soft mb-4">
  <div class="card-body">
    <h5 class="mb-3">Añadir conector</h5>
    <form method="post" action="{{ url_for('puntos.conector_add', punto_id=p.PuntoId) }}" class="row g-2">
      <div class="col-md-3">
        <input class="form-control" name="nombre" placeholder="Nombre (p. ej. AC / Toma A / Toma B)" required>
      </div>
      <div class="col-md-5">
        <input class="form-control" name="url" placeholder="URL completa del conector (PTP)" required>
      </div>
      <div class="col-md-2">
        <input class="form-control" name="tipo" placeholder="Tipo (AC/DC/Tipo2... opcional)">
      </div>
      <div class="col-md-1">
        <input class="form-control" name="orden" type="number" value="1" min="1">
      </div>
      <div class="col-md-1 d-grid">
        <button class="btn btn-primary">Añadir</button>
      </div>
    </form>
  </div>
</div>

<div class="card card-soft">
  <div class="card-body">
    <h5 class="mb-3">Conectores</h5>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Tipo</th>
            <th>URL</th>
            <th>Estado actual</th>
            <th>Última lectura (UTC)</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for c in conectores %}
          {% set e = estado_map.get(c.ConectorId) %}
          <tr>
            <td class="fw-semibold">{{ c.Nombre }}</td>
            <td>{{ c.Tipo or "-" }}</td>
            <td class="small text-break" style="max-width: 360px;">
              <a href="{{ c.UrlConector }}" target="_blank" rel="noopener">Abrir Conector</a>
            </td>
            <td>
              {% if e %}
                {% set st = e.Estado or 'Desconocido' %}
                <span class="badge {% if st=='Libre' %}bg-success{% elif st=='Ocupado' %}bg-danger{% elif st=='Reservado' %}bg-warning text-dark{% elif st in ['Averiado','No disponible'] %}bg-secondary{% else %}bg-dark{% endif %}">
                  {{ st }}
                </span>
              {% else %}
                <span class="badge bg-dark">Sin datos</span>
              {% endif %}
            </td>
            <td>{{ e.CapturedAtUtc if e else '-' }}</td>
            <td class="text-end">
              <form method="post" action="{{ url_for('puntos.conector_toggle', punto_id=p.PuntoId, conector_id=c.ConectorId) }}" class="d-inline">
                <button class="btn btn-sm {% if c.Activo %}btn-outline-warning{% else %}btn-outline-success{% endif %}">
                  {% if c.Activo %}Desactivar{% else %}Activar{% endif %}
                </button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="6" class="text-secondary">Aún no hay conectores.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
<script>
document.getElementById('btn-refresh-punto').addEventListener('click', async () => {
  const btn = event.currentTarget;
  btn.disabled = true; btn.textContent = 'Actualizando...';
  try {
    const res = await fetch('{{ url_for("puntos.punto_refresh", punto_id=p.PuntoId) }}', { method: 'POST' });
    const data = await res.json();
    const box = document.getElementById('punto-refresh-result');
    if (!data.ok) {
      box.innerHTML = `<div class="alert alert-danger">⚠️ ${data.error || 'Error desconocido'}</div>`;
    } else {
      box.innerHTML = `<div class="alert alert-success">✅ Actualizados ${data.count} conectores de este punto.</div>`;
      // Si quieres, aquí podrías hacer location.reload() para ver los nuevos estados en la tabla:
      // setTimeout(() => location.reload(), 800);
    }
  } catch (e) {
    document.getElementById('punto-refresh-result').innerHTML =
      `<div class="alert alert-danger">⚠️ Fallo al refrescar: ${e}</div>`;
  } finally {
    btn.disabled = false; btn.textContent = 'Refrescar estados de este punto';
  }
});
</script>